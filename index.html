<!DOCTYPE html>
<html>
<head>
    <title>LoRa Emergency Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
        }
        #container { display: flex; height: 100vh; }
        #map-container { flex: 2; height: 100%; }
        #map { height: 100%; width: 100%; }
        
        #history-container {
            flex: 1.2; /* Slightly wider to fit the new column */
            padding: 20px;
            background-color: #fff;
            border-left: 2px solid #e0e0e0;
            overflow-y: auto;
        }
        #header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #343a40;
        }
        h2 { margin: 0; color: #343a40; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #343a40; }
        
        .btn {
            padding: 8px 12px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; transition: background-color 0.2s;
        }
        #clear-all-btn { background-color: #ffc107; color: #212529; }
        #clear-all-btn:hover { background-color: #e0a800; }
        .close-btn { background-color: #dc3545; color: white; padding: 6px 10px; font-size: 0.85em; }
        .close-btn:hover { background-color: #c82333; }
        
        .sos-alert { background-color: #ffebee; font-weight: bold; color: #c62828; }
        .vehicle-badge { background-color: #e9ecef; padding: 4px 8px; border-radius: 4px; border: 1px solid #ced4da; }
    </style>
</head>
<body>

<div id="container">
    <div id="map-container">
        <div id="map"></div>
    </div>

    <div id="history-container">
        <div id="header">
            <h2>Emergency Fleet History</h2>
            <button id="clear-all-btn" class="btn" onclick="clearAllCases()">Clear All</button>
        </div>
        <table id="history-table">
            <thead>
                <tr>
                    <th>VEHICLE NO.</th>
                    <th>TYPE</th>
                    <th>LATITUDE</th>
                    <th>LONGITUDE</th>
                    <th>TIME</th>
                    <th>ACTION</th>
                </tr>
            </thead>
            <tbody id="history-body">
                </tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAXHGF2-PukQDz2bzk_-kRn7EZhTYIC0vU",
        projectId: "myloramap-4cc73",
        databaseURL: "https://myloramap-4cc73-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. MAP INITIALIZATION
    const map = L.map('map').setView([8.91, 76.63], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 3. DATA MANAGEMENT
    let caseHistory = JSON.parse(localStorage.getItem('loraCaseHistory')) || [];
    let markers = []; 

    function renderHistory() {
        const tableBody = document.getElementById('history-body');
        tableBody.innerHTML = ''; 

        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        caseHistory.forEach((caseData, index) => {
            const row = tableBody.insertRow();
            if (caseData.msg.includes("SOS")) {
                row.classList.add("sos-alert");
            }
            
            // NEW COLUMN DATA ADDED HERE
            row.innerHTML = `
                <td><span class="vehicle-badge">${caseData.vehicleNum}</span></td>
                <td>${caseData.msg}</td>
                <td>${caseData.lat.toFixed(4)}</td>
                <td>${caseData.lng.toFixed(4)}</td>
                <td>${caseData.time}</td>
                <td><button class="btn close-btn" onclick="closeCase(${index})">Close</button></td>
            `;

            // Update Map Popup to include Vehicle Number
            const marker = L.marker([caseData.lat, caseData.lng]).addTo(map);
            marker.bindPopup(`<b>Vehicle: ${caseData.vehicleNum}</b><br>Status: ${caseData.msg}<br>Time: ${caseData.time}`);
            markers.push(marker); 
        });

        if (caseHistory.length > 0) {
            map.setView([caseHistory[0].lat, caseHistory[0].lng], 15);
        }
    }

    function closeCase(index) {
        caseHistory.splice(index, 1);
        localStorage.setItem('loraCaseHistory', JSON.stringify(caseHistory));
        renderHistory();
    }

    function clearAllCases() {
        if (confirm("Are you sure you want to clear all history?")) {
            caseHistory = [];
            localStorage.removeItem('loraCaseHistory');
            renderHistory();
        }
    }

    // 4. FIREBASE LISTENER
    db.ref("location").on("value", (snapshot) => {
        const data = snapshot.val();
        if (data && data.lat && data.lng) {
            
            const newCase = {
                // If the hardware doesn't send a vehicle number yet, it defaults to "UNKNOWN"
                vehicleNum: data.vehicleNum || "UNKNOWN", 
                lat: data.lat,
                lng: data.lng,
                msg: data.msg,
                time: data.time
            };

            caseHistory.unshift(newCase);

            if (caseHistory.length > 10) {
                caseHistory.pop(); 
            }

            localStorage.setItem('loraCaseHistory', JSON.stringify(caseHistory));
            renderHistory();

            if (data.msg.includes("SOS")) {
                let alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
                alertSound.play().catch(e => console.log("Audio play failed:", e));
            }
        }
    });

    renderHistory();
</script>
</body>
</html>
